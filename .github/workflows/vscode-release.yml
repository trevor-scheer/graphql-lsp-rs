name: VSCode Extension Release

permissions:
  contents: write

# This workflow runs when you push a git tag for VSCode extension releases
# Use tags like vscode-v0.1.1 to trigger this workflow
on:
  pull_request:
    paths:
      - '.github/workflows/vscode-release.yml'
  push:
    tags:
      - 'vscode-v*'

jobs:
  # Check if we should run (only on actual tags, not PRs)
  plan:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ !github.event.pull_request && github.ref_name || '' }}
      publishing: ${{ !github.event.pull_request }}
      is_prerelease: ${{ contains(github.ref_name, '-') }}
    steps:
      - name: Check tag
        run: |
          TAG="${{ needs.plan.outputs.tag }}"
          if [ -n "$TAG" ]; then
            echo "Publishing VSCode extension for tag: $TAG"
          else
            echo "Dry run for PR"
          fi

  # Build and package the VSCode extension
  build-vscode-extension:
    needs: plan
    if: ${{ needs.plan.outputs.publishing == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: editors/vscode/package-lock.json

      - name: Install dependencies
        working-directory: editors/vscode
        run: npm ci

      - name: Build extension
        working-directory: editors/vscode
        run: npm run compile

      - name: Package extension
        working-directory: editors/vscode
        run: npm run package

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension
          path: editors/vscode/*.vsix

  # Create GitHub release and upload the VSIX
  release:
    needs:
      - plan
      - build-vscode-extension
    if: ${{ needs.plan.outputs.publishing == 'true' }}
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Download VSIX artifact
        uses: actions/download-artifact@v4
        with:
          name: vscode-extension
          path: artifacts

      - name: Create GitHub Release
        env:
          PRERELEASE_FLAG: ${{ needs.plan.outputs.is_prerelease == 'true' && '--prerelease' || '' }}
          TAG: ${{ needs.plan.outputs.tag }}
        run: |
          # Create or update the release
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "Release $TAG already exists, uploading VSIX to existing release"
            gh release upload "$TAG" artifacts/*.vsix --clobber
          else
            echo "Creating new release $TAG with VSIX"
            gh release create "$TAG" \
              --target "$GITHUB_SHA" \
              $PRERELEASE_FLAG \
              --title "GraphQL LSP VSCode Extension $TAG" \
              --notes "VSCode Extension release for version $TAG. Download the .vsix file and install it in VS Code using the Extensions view menu or by running: code --install-extension graphql-lsp-*.vsix" \
              artifacts/*.vsix
          fi
